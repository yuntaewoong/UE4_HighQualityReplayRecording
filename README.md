# 개요
- 경희소융 X 펄어비스 인재양성 프로그램에서 진행한 프로젝트
- 프로젝트 진행 기간: 2022년 10월 ~ 2023년 1월(4개월)
- 지도 교수님: 경희대학교 소프트웨어 융합학과 강형엽 교수님
- 진행 방식: 매 2주마다 교수님께 활동내역 보고 & 피드백
- 소개 영상: https://www.youtube.com/watch?v=Rxb3yeUVMB4

# 실행 방법
본 프로젝트는 NVidia 연구진들의 언리얼 레포지토리인  [NvRTX](https://github.com/NvRTX/UnrealEngine) 레포지토리를 개조하면서 진행했기 때문에  
별도로 언리얼 엔진을 빌드해야 실행할 수 있습니다.  
개조 언리얼 엔진 링크: https://github.com/yuntaewoong/UnrealEngine_NvRTX  

   
실행 과정
```
1. 위 레포지토리의 NvRTX_Caustics-4.26 branch코드로 언리얼 엔진빌드(Epic Games Organization가입 필요)
2. .uproject파일 우클릭 후 엔진 버전을 빌드한 엔진으로 선택
3. .sln 파일을 통해서 언리얼 프로젝트 빌드
4. .uproject 파일 실행 
```

# 프로젝트 소개
## Motivation
저는 게임을 플레이할 때, 리플레이 소위 말하는 `움짤`을 많이 녹화하는 편입니다.  
게임을 플레이하면서 재미있는 상황이 발생했을 때 나중에 다시보기 위해 기록하거나  
개발진들이 그래픽적으로 힘을 실은 장면에서의 인상을 기록하기 위함입니다.  
그렇지만, 매번 녹화를 하면서 다음과 같은 의문이 들었습니다.  
```
왜 리플레이를 기록할 때, 인게임 그래픽 옵션 그대로 리플레이를 기록해야 하지?
렌더링 과정에 시간투자를 더 하고 고퀄리티의 동영상을 얻게 해줄 수도 있는것 아닌가?
```
특히, 닌텐도 스위치같은 저사양 기기로 저퀄리티 동영상을 녹화할 때마다 이런 생각이  
강하게 들었습니다.

이러한 의문이 Motivation이 되어 `고퀄리티 게임영상 녹화 기술`프로젝트를 진행하게 되었습니다.  


## 문제 정의
먼저 기존 게임들의 리플레이 시스템들을 분석해봤습니다.
1. LOL과 같은 온라인 대전 게임  
(설명 추가예정)
2. AAA게임들의 포토모드  
(설명 추가예정)  

기존의 게임에 마련된 리플레이 시스템들은 모두 `플레이 기록의 저장`에만 초점을 맞추고  
`퀄리티`에는 집중을 하지 않은 것을 알 수 있었습니다.  
그래서 저는 `퀄리티`에 초점을 맞춘 새로운 리플레이 시스템을 언리얼 엔진상에서 동작하도록  
구현하는 것을 목표로 잡았습니다.

## 해결 방법
1. 리플레이 기록  
먼저 In Game에서 특정한 구간의 리플레이를 기록할 수 있는 방법을 찾아야 했습니다.  
구글링 결과 언리얼에는 엔진단에서 구현된 리플레이 시스템이 있는 것을 확인했습니다.  
https://docs.unrealengine.com/4.27/en-US/TestingAndOptimization/ReplaySystem/  
이 기능은 클라이언트-서버 구조의 게임에서 각 클라이언트의 정보를 동기화 하기위해 RPC함수호출하는 것을 응용해서 해당 정보를 디스크에 저장해서 다시 플레이를 재구성할 수 있도록 해주는 기능입니다.  
이 기능을 사용해서 특정 구간의 게이머의 플레이를 디스크에 저용량 파일화 해서 저장할 수 있었습니다.     

2. 리플레이의 고퀄리티 렌더링  
프로젝트의 목적에 맞게 기록된 플레이어의 리플레이를 기존 게임에서 사용하던 방식과는  
다른 렌더링 방식을 적용하는 방법을 고민해본 결과  
최근 나온 기술인 ReSTIR GI기술을 사용하자는 결론을 내렸습니다.  
이 기술이 이미 언리얼에 개발되어 있는지 확인해본 결과 Nvidia연구진들의  
NvRTX 언리얼 엔진코드를 발견하게 되었고 NvRTX엔진을 빌드해서 고퀄리티 렌더링이 가능하게 되었습니다.  

3. 고퀄리티 렌더링 과정의 동영상 Encoding  
렌더링 과정을 동영상으로 Encoding하는 부분은 다음 레포지토리의 코드를 이용했습니다.[SimpleVideoCapture](https://github.com/pafuhana1213/SimpleVideoCapture)  
하지만, 이대로 ReSTIR GI기술을 사용해서 리플레이를 렌더링 하면, 프레임 드랍이 일어납니다.  
그래서 프레임드랍이 일어나는 리플레이를 고정된 프레임의 동영상으로 Encoding하는 기술을 추가 개발하였습니다.  
```
1. 리플레이를 렌더링 할 때 bUseFixedFramerate변수를 True로 설정해서 게임 플레이에 적용되는   Delta Time을 고정시켜서 프레임 드랍이 일어나더라도 단지 게임이 느리게 진행되도록 변경
2. 언리얼 엔진의 NvVideoEncoder.cpp 코드 수정(Encoding되는 Frame의 Duration(이전 프레임과의 간격), TimeStamp(동영상 진행시간)을 목표로하는 FPS에 맞게 고정)   
```



## 참고 논문
- [ReSTIR](https://research.nvidia.com/sites/default/files/pubs/2020-07_Spatiotemporal-reservoir-resampling/ReSTIR.pdf)
- [ReSTIR GI](https://d1qx31qr3h6wln.cloudfront.net/publications/ReSTIR%20GI.pdf)


